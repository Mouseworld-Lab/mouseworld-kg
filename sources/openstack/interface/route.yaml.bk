- beans:
  - name: mappingTemplate
    type: "#class:com.cefriel.util.ChimeraResourceBean"
    properties:
      url: "header://deviceIdHeader"
      serializationFormat: "string"
  - name: mappingHeaders
    type: "#class:com.cefriel.util.ChimeraResourceBean"
    properties:
      url: "file://./mappings.vm"
      serializationFormat: "vtl"

- from:
    uri: "timer:fetchServers?repeatCount=1"
    steps:
      - setHeader:
          name: "X-Auth-Token"
          constant: "gAAAAABoLz3DQvglJ_dC-KoiYLaYxnYk-fqE394ZjfRioVWE6h9ZK2izI_Mm4qV9fPQODaxFCsHtx87azqZOWc0905NcVm5jqanH9fOf93DXaNGLjItt83VsFc1mMgsFMCek8PyRRfgKPYgZRcXatFJNhVF5cZ-mRAHHAYgZDlYRy1vFIA5ABXDW_xHx1L3D_9mDTg5UtzKv"
      - setHeader:
          name: "Accept"
          constant: "application/json"
      - to:
          #uri: "http://192.168.27.44:9696/v2.0/ports"
          uri: "http://192.168.27.44:8774/v2.1/servers/detail"
      - split:
          jsonpath: "$.servers"
          steps:
            - to:
                uri: "direct:liftOpenStack"

- from:
    uri: "direct:liftOpenStack"
    steps:
      - log:
          message: "Retrieved data from OpenStack: ${body}"
      - setHeader:
          name: "deviceIdHeader"
          simple: "deviceId:${jsonpath($.name)}"
      - log:
          message: "header value is : ${header.deviceIdHeader}"
      - toD:
          uri: "mapt://json"
          parameters:
            template: "#bean:mappingTemplate"
            keyValuePairs: "#bean:mappingHeaders"
            format: "turtle"
      - to:
          uri: "direct:storeLifted"

- from:
    uri: "direct:storeLifted"
    steps:
      - to:
          uri: "file:output"
          parameters:
            fileName: "output.ttl"
            noop: true
      - log:
          message: "Lifting saved to output/output.ttl"

# - from:
#     uri: "direct:storeTriplestore"
#     steps:
#       - to:
#           uri: "kamelet:graph-get-rdf4j-sink"
#           parameters:
#             serverAddress: "http://127.0.0.1"
#             serverPort: 7200
#             repositoryId: "default"
#       - log:
#           message: "Lifting stored in remote triplestore"
